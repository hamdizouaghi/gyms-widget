
<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>Gyms</title>

<style>
  :root{
    --card-radius: 16px;
    --card-bg: #fff;
    --card-border: #e5e7eb;
    --shadow: 0 2px 12px rgba(0,0,0,0.08);

    --text-muted: #6b7280;
    --text-strong: #111827;
    --accent: #f5a623; /* stars color */
  }

  body { font-family: Arial, sans-serif; margin:16px; }

  /* Top filters bar */
  #filters-bar{
    display:flex;
    gap:12px;
    flex-wrap:wrap;
    margin-bottom:16px;
  }
  .filter-select{
    appearance:none;
    -webkit-appearance:none;
    -moz-appearance:none;
    padding:10px 14px;
    border:1px solid #d1d5db;
    border-radius:10px;
    background:#fff;
    color:#111827;
    font-size:14px;
    line-height:1;
    cursor:pointer;
    min-width:140px;
  }

  /* Grid */
  #gyms {
    display: grid;
    grid-template-columns: repeat(3, minmax(280px, 1fr));
    gap: 16px;
  }
  @media (max-width:1200px){
    #gyms { grid-template-columns: repeat(2, minmax(280px, 1fr)); }
  }
  @media (max-width:680px){
    #gyms { grid-template-columns: 1fr; }
  }

  /* Card */
  .gym-card{
    display:flex;
    flex-direction:column;
    border:1px solid var(--card-border);
    border-radius: var(--card-radius);
    background: var(--card-bg);
    box-shadow: var(--shadow);
    overflow:hidden; /* round image corners at top */
  }

  /* Cover image on top */
  .gym-cover{
    width:100%;
    height:200px;           /* adjust if you want taller image (e.g. 220–260px) */
    object-fit:cover;
    display:block;
  }
  .cover-placeholder{
    width:100%;
    height:200px;
    background: linear-gradient(135deg, #eee, #ddd);
  }

  /* Info section */
  .gym-info{
    padding:12px 16px 16px;
  }

  .gym-title{
    font-size:14px;
    color:#111827;
    margin:8px 0 6px;
  }

  .gym-city{
    font-size:18px;
    font-weight:700;
    color:var(--text-strong);
    margin:0 0 6px;
  }

  .gym-line{
    font-size:14px;
    color:#111827;
    margin:2px 0;
  }
  .gym-line.muted{
    color:var(--text-muted);
  }

  /* Rating */
  .rating-label{
    font-size:13px;
    color:var(--text-muted);
    margin-top:8px;
    margin-bottom:4px;
  }
  .stars{
    color: var(--accent);
    font-size:16px;
    letter-spacing:1px;
  }

  /* tiny carousel dots (visual only) */
  .dots{
    position:relative;
    top:-14px;
    display:flex;
    gap:6px;
    justify-content:center;
    align-items:center;
  }
  .dot{
    width:6px; height:6px;
    border-radius:50%;
    background:#ddd;
  }
  .dot.active{ background:#bbb; }

  /* Pager */
  #pager {
    margin-top: 12px;
    display: flex;
    gap: 8px;
    align-items: center;
    justify-content: center;
    flex-wrap: wrap;
  }
  .pager-btn {
    padding: 8px 12px;
    border: 1px solid #d1d5db;
    border-radius: 8px;
    background: #fff;
    color: #111827;
    font-size: 14px;
    cursor: pointer;
    box-shadow: 0 1px 6px rgba(0,0,0,0.05);
  }
  .pager-btn:disabled {
    opacity: 0.5;
    cursor: not-allowed;
  }
  .pager-status {
    font-size: 14px;
    color: var(--text-muted);
    padding: 4px 8px;
  }
</style>
</head>

<body>

<div id="filters-bar"></div>
<div id="gyms"></div>
<div id="pager"></div>

<script>
document.addEventListener('DOMContentLoaded', function() {
  /* ======== CONFIG ======== */
  const SHEET_URL = "https://opensheet.elk.sh/1-M0Olh2CNmzAkNrQAYC246cJAPkElQZcEh9aLfYbb54/Sheet1";
  const PAGE_SIZE = 12; // Show exactly 10 per page

  /* ======== DOM ======== */
  const gymsContainer = document.getElementById("gyms");
  const filtersBar = document.getElementById("filters-bar");
  const pagerContainer = document.getElementById("pager");

  /* ======== FILTERS BAR ======== */
  filtersBar.innerHTML = `
    <select id="googleRating" class="filter-select" aria-label="Google rating">
      <option value="0">Google rating</option>
      <option value="1">★ 1+</option>
      <option value="2">★ 2+</option>
      <option value="3">★ 3+</option>
      <option value="4">★ 4+</option>
      <option value="4.5">★ 4.5+</option>
      <option value="5">★ 5</option>
    </select>

    <select id="governance" class="filter-select" aria-label="Governorate">
      <option value="">Governorate</option>
      <option value="Ariana">Ariana</option>
      <option value="Béja">Béja</option>
      <option value="Ben Arous">Ben Arous</option>
      <option value="Bizerte">Bizerte</option>
      <option value="Gabès">Gabès</option>
      <option value="Gafsa">Gafsa</option>
      <option value="Jendouba">Jendouba</option>
      <option value="Kairouan">Kairouan</option>
      <option value="Kasserine">Kasserine</option>
      <option value="Kebili">Kebili</option>
      <option value="Kef">Kef</option>
      <option value="Mahdia">Mahdia</option>
      <option value="Manouba">Manouba</option>
      <option value="Medenine">Medenine</option>
      <option value="Monastir">Monastir</option>
      <option value="Nabeul">Nabeul</option>
      <option value="Sfax">Sfax</option>
      <option value="Sidi Bouzid">Sidi Bouzid</option>
      <option value="Siliana">Siliana</option>
      <option value="Sousse">Sousse</option>
      <option value="Tataouine">Tataouine</option>
      <option value="Tozeur">Tozeur</option>
      <option value="Tunis">Tunis</option>
      <option value="Zaghouan">Zaghouan</option>
    </select>

    <select id="cityFilter" class="filter-select" aria-label="City" disabled>
      <option value="">City</option>
    </select>
  `;

  /* ======== STATE ======== */
  const googleRatingSelect = document.getElementById("googleRating");
  const governanceSelect   = document.getElementById("governance");
  const cityFilterSelect   = document.getElementById("cityFilter");

  let gymsData = [];      // raw from sheet (normalized)
  let filteredData = [];  // after filters
  let currentPage = 1;

  /* ======== FETCH ======== */
  fetch(SHEET_URL)
    .then(res => res.json())
    .then(data => {
      // Normalize rating + unify "Image" prop from sheet "image"/"Image"
      gymsData = data.map(row => {
        const rawImage = (row.image ?? row.Image ?? "").toString().trim();
        return {
          ...row,
          Image: rawImage, // unified name
          _rateNum: parseFloat(
            String(row.Rate || "")
              .replace(",", ".")
              .replace(/[^0-9.]/g, "")
          ),
        };
      });

      refreshCityOptions();
      applyFiltersAndRender();
    })
    .catch(err => {
      console.error("Failed to load sheet data:", err);
      gymsContainer.innerHTML = `<p style="color:#b00;">Failed to load gyms. Please try again later.</p>`;
    });

  /* ======== FILTERS ======== */
  function applyFiltersAndRender(){
    const minRate = parseFloat(googleRatingSelect.value || "0");
    const govVal  = (governanceSelect.value || "").trim();
    const cityVal = (cityFilterSelect.value || "").trim();

    filteredData = gymsData.filter(gym => {
      // Rating
      const passRating = !isFinite(minRate) || minRate === 0
        ? true
        : (isFinite(gym._rateNum) && gym._rateNum >= minRate);

      // Governorate
      const passGov = govVal === "" ? true : String(gym.Governorate || "").trim() === govVal;

      // City
      const passCity = cityVal === "" ? true : String(gym.City || "").trim() === cityVal;

      return passRating && passGov && passCity;
    });

    currentPage = 1;
    renderPage();
  }

  function refreshCityOptions() {
    const govVal = String(governanceSelect.value || "").trim();

    if (!govVal) {
      cityFilterSelect.innerHTML = `<option value="">City</option>`;
      cityFilterSelect.disabled = true;
      cityFilterSelect.value = "";
      return;
    }

    const citySet = new Set(
      gymsData
        .filter(g => String(g.Governorate || "").trim() === govVal)
        .map(g => String(g.City || "").trim())
        .filter(v => v.length > 0)
    );

    const optionsHtml = ['<option value="">City</option>']
      .concat([...citySet].sort().map(c => `<option value="${escapeHtml(c)}">${escapeHtml(c)}</option>`))
      .join('');

    const prev = cityFilterSelect.value;
    cityFilterSelect.innerHTML = optionsHtml;
    cityFilterSelect.disabled = false;

    if (prev && citySet.has(prev)) {
      cityFilterSelect.value = prev;
    } else {
      cityFilterSelect.value = "";
    }
  }

  googleRatingSelect.addEventListener("change", applyFiltersAndRender);
  governanceSelect.addEventListener("change", () => {
    refreshCityOptions();
    applyFiltersAndRender();
  });
  cityFilterSelect.addEventListener("change", applyFiltersAndRender);

  /* ======== PAGING ======== */
  function renderPage(){
    const total = filteredData.length;
    const totalPages = Math.max(1, Math.ceil(total / PAGE_SIZE));
    currentPage = Math.min(Math.max(1, currentPage), totalPages);

    const startIdx = (currentPage - 1) * PAGE_SIZE;
    const endIdx = Math.min(startIdx + PAGE_SIZE, total);
    const slice = filteredData.slice(startIdx, endIdx);

    renderGyms(slice);
    renderPager(total, totalPages, startIdx, endIdx);
  }

  function renderPager(total, totalPages, startIdx, endIdx){
    // Hide the pager if there is only one page or no results
    if (totalPages <= 1 || total === 0) {
      pagerContainer.innerHTML = "";
      return;
    }

    const prevDisabled = currentPage <= 1 ? "disabled" : "";
    const nextDisabled = currentPage >= totalPages ? "disabled" : "";

    pagerContainer.innerHTML = `
      <button class="pager-btn" id="btnPrev" ${prevDisabled} aria-label="Previous page">Previous</button>
      <span class="pager-status">Page ${currentPage} of ${totalPages} • Showing ${startIdx + 1}–${endIdx} of ${total}</span>
      <button class="pager-btn" id="btnNext" ${nextDisabled} aria-label="Next page">Next</button>
    `;

    const btnPrev = document.getElementById("btnPrev");
    const btnNext = document.getElementById("btnNext");

    if (btnPrev) {
      btnPrev.addEventListener("click", () => {
        if (currentPage > 1) {
          currentPage--;
          renderPage();
        }
      });
    }

    if (btnNext) {
      btnNext.addEventListener("click", () => {
        const tp = Math.ceil(total / PAGE_SIZE);
        if (currentPage < tp) {
          currentPage++;
          renderPage();
        }
      });
    }

    // Optional: keyboard shortcuts ←/→ for pagination (bind once)
    if (!window.__pagerKeysBound) {
      window.__pagerKeysBound = true;
      document.addEventListener("keydown", (e) => {
        const tag = (e.target && e.target.tagName) || "";
        // Avoid interfering with inputs/selects
        if (["INPUT", "TEXTAREA", "SELECT"].includes(tag)) return;

        if (e.key === "ArrowLeft") {
          if (currentPage > 1) {
            currentPage--;
            renderPage();
          }
        } else if (e.key === "ArrowRight") {
          const tp = Math.ceil(total / PAGE_SIZE);
          if (currentPage < tp) {
            currentPage++;
            renderPage();
          }
        }
      });
    }
  }

  /* ======== HELPERS ======== */
  function normalizeImageUrl(url) {
    const u = String(url).trim();

    // Convert Google Drive "file/d/<id>/view" to direct image
    const mFile = u.match(/drive\.google\.com\/file\/d\/([-\w]{25,})/);
    if (mFile) {
      return `https://drive.google.com/uc?export=view&id=${mFile[1]}`;
    }

    // Convert any link that has ?id=<id>
    const mId = u.match(/[?&]id=([-\w]{25,})/);
    if (mId) {
      return `https://drive.google.com/uc?export=view&id=${mId[1]}`;
    }

    // Already a direct (uc?export=view) or a normal image URL
    return u;
  }

  function firstImageUrl(raw) {
    if (!raw) return "";
    // Your sheet shows multiple links separated by spaces; some rows can use '|'
    // Split on pipe or whitespace (one or more)
    const parts = String(raw).split(/[|\s]+/).map(s => s.trim()).filter(Boolean);
    if (parts.length === 0) return "";
    return normalizeImageUrl(parts[0]);
  }

  function getStars(rate){
    const max = 5;
    const full = Math.floor(rate);
    const half = (rate - full >= 0.5) ? 1 : 0;
    const empty = max - full - half;
    return `${"★".repeat(full)}${half ? "☆" : ""}${"✩".repeat(empty)}`;
  }

  function escapeHtml(str){
    return String(str)
      .replace(/&/g,'&amp;')
      .replace(/</g,'&lt;')
      .replace(/>/g,'&gt;')
      .replace(/"/g,'&quot;')
      .replace(/'/g,'&#039;');
  }

  /* ======== RENDER ======== */
  function renderGyms(list){
    if (!list || list.length === 0){
      gymsContainer.innerHTML = `<p>No results</p>`;
      return;
    }

    let html = "";
    list.forEach(gym => {
      // ✅ Only one image (the first), normalized
      const coverUrl = firstImageUrl(gym.Image);

      const rateVal = isFinite(gym._rateNum) ? gym._rateNum : null;
      const gymName = escapeHtml(gym.Name || '');

      html += `
        <article class="gym-card">
          ${
            coverUrl
              ? `<img classml(coverUrl)}`
              : `<div class="cover-placeholder" aria-hidden="true"></div>`
          }

          <div class="dots" aria-hidden="true">
            <span class="dot active"></span>
            <span class="dot"></span>
            <span class="dot"></span>
            <span class="dot"></span>
          </div>

          <div class="gym-info">
            <div class="gym-title">${gymName}</div>

            <div class="gym-line">
              Governorate <span class="gym-sep">|</span>
              <span class="gym-line muted">${escapeHtml(gym.Governorate || '')}</span>
              <span class="gym-sep">|</span>
              City <span class="gym-sep">|</span>
              <span class="gym-line muted">${escapeHtml(gym.City || '')}</span>
            </div>

            <div class="rating-label">Google Rating</div>
            <div class="stars">${rateVal !== null ? getStars(rateVal) : 'N/A'}</div>
          </div>

        </article>
      `;
    });

    gymsContainer.innerHTML = html;
  }
});
</script>
</body>
</html>
